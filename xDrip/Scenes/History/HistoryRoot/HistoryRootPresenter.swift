//
//  HistoryRootPresenter.swift
//  xDrip
//
//  Created by Artem Kalmykov on 11.03.2020.
//  Copyright (c) 2020 Faifly. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

protocol HistoryRootPresentationLogic {
    func presentLoad(response: HistoryRoot.Load.Response)
    func presentGlucoseData(response: HistoryRoot.GlucoseDataUpdate.Response)
    func presentChartTimeFrameChange(response: HistoryRoot.ChangeEntriesChartTimeFrame.Response)
}

final class HistoryRootPresenter: HistoryRootPresentationLogic {
    weak var viewController: HistoryRootDisplayLogic?
    
    private let glucoseFormattingWorker: HomeGlucoseFormattingWorkerProtocol
    private let homeEntriesFormattingWorker: HomeEntriesFormattingWorkerProtocol
    
    init() {
        glucoseFormattingWorker = HomeGlucoseFormattingWorker()
        homeEntriesFormattingWorker = HomeEntriesFormattingWorker()
    }
    // MARK: Do something
    
    func presentLoad(response: HistoryRoot.Load.Response) {
        let viewModel = HistoryRoot.Load.ViewModel(globalTimeInterval: response.globalTimeInterval)
        viewController?.displayLoad(viewModel: viewModel)
    }
    
    func presentGlucoseData(response: HistoryRoot.GlucoseDataUpdate.Response) {
        let values = glucoseFormattingWorker.formatEntries(response.glucoseData)
        let stroke: [BaseChartEntry]
        if let date = response.date {
            stroke = homeEntriesFormattingWorker.calculateChartValues(for: date, allBasals: response.basalData)
        } else {
            stroke = homeEntriesFormattingWorker.calculateChartValues(for: 14 * 24, allBasals: response.basalData)
        }
        
        let unit = User.current.settings.unit.label
        let dataSection = glucoseFormattingWorker.formatDataSection(response.intervalGlucoseData)
        
        let viewModel = HistoryRoot.GlucoseDataUpdate.ViewModel(
            glucoseValues: values,
            basalDisplayMode: response.basalDisplayMode,
            strokeChartBasalValues: stroke,
            unit: unit,
            dataSection: dataSection,
            date: response.date
        )
        viewController?.displayGlucoseData(viewModel: viewModel)
    }
    
    func presentChartTimeFrameChange(response: HistoryRoot.ChangeEntriesChartTimeFrame.Response) {
        let viewModel = HistoryRoot.ChangeEntriesChartTimeFrame.ViewModel(timeInterval: response.timeInterval)
        viewController?.displayChartTimeFrameChange(viewModel: viewModel)
    }
}
