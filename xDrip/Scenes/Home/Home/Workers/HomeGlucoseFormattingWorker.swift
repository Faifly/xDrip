//
//  HomeGlucoseFormattingWorker.swift
//  xDrip
//
//  Created by Artem Kalmykov on 17.04.2020.
//  Copyright (c) 2020 Faifly. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

private struct HomeGlucoseEntry: GlucoseChartGlucoseEntry {
    let value: Double
    let date: Date
    let severity: GlucoseChartSeverityLevel
}

private struct HomeGlucoseCurrentInfoEntry: GlucoseCurrentInfoEntry {
    let glucoseValue: Double
    let slopeValue: Double
    let lastScanDate: Date
    let difValue: Double
}

protocol HomeGlucoseFormattingWorkerProtocol {
    func formatEntries(_ entries: [GlucoseReading]) -> [GlucoseChartGlucoseEntry]
    func formatEntry(_ entry: GlucoseReading?) -> GlucoseCurrentInfoEntry?
}

final class HomeGlucoseFormattingWorker: HomeGlucoseFormattingWorkerProtocol {
    func formatEntries(_ entries: [GlucoseReading]) -> [GlucoseChartGlucoseEntry] {
        let settings = User.current.settings
        return entries.map {
            HomeGlucoseEntry(
                value: GlucoseUnit.convertToUserDefined($0.filteredCalculatedValue),
                date: $0.date ?? Date(),
                severity: GlucoseChartSeverityLevel(
                    warningLevel: settings?.warningLevel(forValue: $0.filteredCalculatedValue)
                )
            )
        }
    }
    
    func formatEntry(_ entry: GlucoseReading?) -> GlucoseCurrentInfoEntry? {
        guard let entry = entry else { return nil }
        return HomeGlucoseCurrentInfoEntry(
            glucoseValue: GlucoseUnit.convertToUserDefined(entry.filteredCalculatedValue),
            slopeValue: entry.activeSlope(),
            lastScanDate: entry.date ?? Date(),
            difValue: entry.calculatedValueSlope)
    }
}

fileprivate extension GlucoseChartSeverityLevel {
    init(warningLevel: GlucoseWarningLevel?) {
        guard let level = warningLevel else { self = .normal; return }
        switch level {
        case .low, .high: self = .abnormal
        case .urgentHigh, .urgentLow: self = .critical
        }
    }
}
