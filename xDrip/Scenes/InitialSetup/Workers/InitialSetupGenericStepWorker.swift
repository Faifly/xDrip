//
//  InitialSetupGenericStepWorker.swift
//  xDrip
//
//  Created by Artem Kalmykov on 28.03.2020.
//  Copyright (c) 2020 Faifly. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

final class InitialSetupGenericStepWorker: InitialSetupStepProvidingWorker {
    private var currentStep: InitialSetup.GenericStep? = .intro
    
    func completeStep(_ step: InitialSetupStep) {
        guard let step = step as? InitialSetup.GenericStep else { return }
        
        switch step {
        case .intro:
            currentStep = .deviceMode
            
        case .deviceMode:
            currentStep = .injectionType
            
        case .injectionType:
            currentStep = .settings
            
        case .settings:
            let isFollower = User.current.settings.deviceMode == .follower
            let isNightscoutSyncing = User.current.settings.nightscoutSync?.isEnabled ?? false
            if isFollower || isNightscoutSyncing {
                currentStep = .nightscoutSync
            } else {
                currentStep = .transmitterType
            }
            
        case .nightscoutSync:
            switch User.current.settings.deviceMode {
            case .main: currentStep = .transmitterType
            case .follower: currentStep = .finish
            }
            
        case .transmitterType, .finish:
            currentStep = nil
        }
    }
    
    var nextStep: InitialSetupStep? {
        return currentStep
    }
    
    func initConnectionStep() {}
}

extension InitialSetup.GenericStep: InitialSetupStep {
    func createViewController() -> InitialSetupInteractable {
        switch self {
        case .intro: return InitialSetupIntroViewController()
        case .deviceMode: return InitialSetupDeviceModeViewController()
        case .injectionType: return InitialSetupInjectionTypeViewController()
        case .settings: return InitialSetupSettingsViewController()
        case .transmitterType: return InitialSetupTransmitterTypeViewController()
        case .nightscoutSync: return InitialSetupNightscoutViewController()
        case .finish: return InitialSetupFinishViewController()
        }
    }
}
