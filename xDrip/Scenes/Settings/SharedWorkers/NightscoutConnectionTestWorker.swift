//
//  NightscoutConnectionTestWorker.swift
//  xDrip
//
//  Created by Artem Kalmykov on 13.06.2020.
//  Copyright (c) 2020 Faifly. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

protocol NightscoutConnectionTestWorkerLogic {
    func testNightscoutConnection(tryAuth: Bool, callback: @escaping (Bool, String, UIImage) -> Void)
}

final class NightscoutConnectionTestWorker: NightscoutConnectionTestWorkerLogic {
    func testNightscoutConnection(tryAuth: Bool, callback: @escaping (Bool, String, UIImage) -> Void) {
        NightscoutService.shared.testNightscoutConnection(tryAuth: tryAuth) { success, error in
            if success {
                guard let icon = UIImage(named: "icon_success") else { fatalError() }
                callback(
                    true,
                    "settings_nightscout_cloud_configuration_api_test_result_success".localized,
                    icon
                )
            } else {
                guard let icon = UIImage(named: "icon_error") else { fatalError() }
                
                let message: String
                if let error = error {
                    switch error {
                    case .cantConnect, .invalidURL:
                        message = "settings_nightscout_cloud_configuration_api_test_result_invalid_server".localized
                    case .noAPISecret:
                        message = "settings_nightscout_cloud_configuration_api_test_result_no_secret".localized
                    case .invalidAPISecret:
                        message = "settings_nightscout_cloud_configuration_api_test_result_unauthorized".localized
                    }
                } else {
                    message = "error".localized
                }
                callback(false, message, icon)
            }
        }
    }
}
